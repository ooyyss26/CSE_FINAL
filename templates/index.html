{% extends 'base.html' %}
{% block title %}Products - API Web Interface{% endblock %}
{% block content %}
<div id="loginSection" style="display: none;">
    <div class="text-center">
        <h2>Welcome to Products API</h2>
        <p>Please <a href="/login">login</a> to manage products.</p>
    </div>
</div>

<div id="mainSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Products Management</h1>
        <div>
            <button class="btn btn-primary me-2" onclick="showAddModal()">Add Product</button>
            <button class="btn btn-outline-secondary" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search products by name..." onkeyup="searchProducts()">
    </div>

    <div id="productsContainer" class="row">
        <!-- Products will be loaded here -->
    </div>

    <div id="loadingSpinner" class="text-center" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="noProductsMessage" class="text-center text-muted" style="display: none;">
        No products found.
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <div class="mb-3">
                        <label for="productName" class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentEditingId = null;
let token = localStorage.getItem('token');

document.addEventListener('DOMContentLoaded', function() {
    if (token) {
        document.getElementById('mainSection').style.display = 'block';
        loadProducts();
    } else {
        document.getElementById('loginSection').style.display = 'block';
    }
});

function logout() {
    localStorage.removeItem('token');
    location.reload();
}

function showAddModal() {
    currentEditingId = null;
    document.getElementById('modalTitle').textContent = 'Add Product';
    document.getElementById('productForm').reset();
    new bootstrap.Modal(document.getElementById('productModal')).show();
}

function editProduct(id, name, price) {
    currentEditingId = id;
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('productName').value = name;
    document.getElementById('productPrice').value = price;
    new bootstrap.Modal(document.getElementById('productModal')).show();
}

async function saveProduct() {
    const name = document.getElementById('productName').value;
    const price = parseFloat(document.getElementById('productPrice').value);

    if (!name || isNaN(price) || price < 0) {
        alert('Please enter valid product details.');
        return;
    }

    const url = currentEditingId ? `/products/${currentEditingId}` : '/products';
    const method = currentEditingId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, price })
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts();
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to save product');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}

async function deleteProduct(id) {
    productToDelete = id;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

async function confirmDelete() {
    if (!productToDelete) return;

    try {
        const response = await fetch(`/products/${productToDelete}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadProducts();
        } else {
            alert('Failed to delete product');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    } finally {
        productToDelete = null;
    }
}

async function loadProducts(search = '') {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('productsContainer').innerHTML = '';

    console.log('Token:', token);

    if (!token || token === "null") {
        console.log('Token is null or invalid, logging out');
        logout();
        return;
    }

    try {
        const url = search ? `/products?search=${encodeURIComponent(search)}` : '/products';
        console.log('Fetching URL:', url);
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        if (response.ok) {
            const data = await response.json();
            console.log('Data:', data);
            displayProducts(data.products || []);
        } else if (response.status === 401) {
            console.log('401 error, logging out');
            logout();
        } else {
            console.log('Failed to load products, status:', response.status);
            document.getElementById('productsContainer').innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load products</div></div>';
        }
    } catch (error) {
        console.log('Error type:', error.constructor.name, 'Message:', error.message);
        document.getElementById('productsContainer').innerHTML = '<div class="col-12"><div class="alert alert-danger">Network error. Please try again.</div></div>';
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

function displayProducts(products) {
    const container = document.getElementById('productsContainer');
    const noProducts = document.getElementById('noProductsMessage');

    if (products.length === 0) {
        noProducts.style.display = 'block';
        return;
    }

    noProducts.style.display = 'none';
    container.innerHTML = products.map(product => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text">Price: $${parseFloat(product.price).toFixed(2)}</p>
                    <p class="card-text"><small class="text-muted">ID: ${product.id}</small></p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price})">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value;
    loadProducts(searchTerm);
}
</script>
{% endblock %}
